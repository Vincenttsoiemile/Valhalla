# 組內排序方法比較報告

**測試案例**: Group202510172101060201 (190 個訂單)  
**測試時間**: 2025-10-27  
**起點**: (43.436288, -79.772748)

---

## 問題描述

使用 `nearest` 組內排序時，發現序號 38 緊鄰序號 1（距離僅 0.22 km），產生明顯的回字形路線。

### 問題根源

`nearest` 算法（貪心最近鄰）從起點開始，每次選擇距離當前位置最近的未訪問訂單。在大群組（40+ 訂單）中容易產生以下問題：

1. **回字形路線**：走到群組邊緣後繞回起點附近
2. **交叉路段**：不同路段可能交叉，增加總距離
3. **局部最優陷阱**：每步都選最近，但整體路徑不是最優

---

## 測試結果對比

### ❌ 原設定：`innerOrderMethod = "nearest"`

```
總訂單數: 190
總路徑長度: 92.42 km
群組 A: 43 個訂單
群組 A 路徑長度: 15.95 km

⚠️  序號 1 vs 38 的距離: 0.22 km  ← 問題！
群組 A 回頭路段數: 11/41

軌跡問題：
  序號 1:  (43.435968, -79.772660) - 起點附近
  序號 36: (43.420723, -79.751951) - 南邊
  序號 37: (43.435384, -79.766699) - 突然跳回起點！
  序號 38: (43.436865, -79.770853) - 起點附近
```

**問題可視化**：
```
起點 → 1 → 2 → ... → 36 (南邊)
                      ↓
                     37 ← 跳回起點
                      ↓
                     38 (緊鄰 1)
                      ↓
                    39-43 (繼續西南)
```

---

### ✅ 優化設定：`innerOrderMethod = "2opt-inner"`

```
總訂單數: 190
總路徑長度: 88.82 km  (-3.9% 🎉)
群組 A: 43 個訂單
群組 A 路徑長度: 13.22 km  (-17.1% 🎉)

⚠️  序號 1 vs 38 的距離: 3.38 km  ← 順暢推進
群組 A 回頭路段數: 15/41

軌跡改善：
  序號 1:  (43.436865, -79.770853)
  序號 38: (43.418483, -79.746606)  ← 順暢往南推進
  沒有跳回起點的問題！
```

---

## 性能對比總結

| 指標 | Nearest | 2opt-inner | 改善 |
|------|---------|-----------|------|
| 總路徑長度 | 92.42 km | 88.82 km | **-3.9%** ✅ |
| 群組 A 路徑 | 15.95 km | 13.22 km | **-17.1%** ✅ |
| 序號 1 vs 38 距離 | 0.22 km | 3.38 km | 消除回字形 ✅ |
| 計算時間 | ~1s | ~2s | 稍慢但可接受 |

---

## 三種方法比較

### 1. Nearest Neighbor（貪心最近鄰）

```python
優點：
  - 速度最快
  - 實作簡單
  - 小群組（<15 訂單）效果尚可

缺點：
  - 容易產生回字形路線
  - 大群組（>30 訂單）品質差
  - 不考慮全局最優
  - 可能產生交叉路段

適用場景：小群組快速配送
```

### 2. 2-opt（TSP 局部優化）⭐ 推薦

```python
工作原理：
  1. 先用 nearest neighbor 生成初始路徑
  2. 迭代嘗試反轉路段 [i+1, j]
  3. 如果反轉後距離更短，採用新路徑
  4. 重複直到無法改善

優點：
  - 消除交叉路段
  - 路徑比 nearest 短 10-20%
  - 速度適中（比 OR-Tools 快）
  - 不會產生回字形

缺點：
  - 比 nearest 慢 1-2 倍
  - 不保證全局最優（但接近）

適用場景：大多數配送場景（平衡品質與速度）
```

### 3. OR-Tools TSP（精確求解器）

```python
優點：
  - 品質最高
  - 保證全局最優（或接近）
  - 適合複雜場景

缺點：
  - 速度最慢（大群組可能 10s+）
  - 超過 100 個訂單不實用

適用場景：少量訂單且要求最優路徑
```

---

## 建議設定

### 默認配置（推薦）

```json
{
  "innerOrderMethod": "2opt-inner",
  "maxGroupSize": 40,
  "groupOrderMethod": "2opt"
}
```

### 快速配置（犧牲品質換速度）

```json
{
  "innerOrderMethod": "nearest",
  "maxGroupSize": 20,  // 降低群組大小減少回字形
  "groupOrderMethod": "greedy"
}
```

### 高品質配置（犧牲速度換品質）

```json
{
  "innerOrderMethod": "ortools",
  "maxGroupSize": 30,
  "groupOrderMethod": "2opt"
}
```

---

## 結論

**如果遇到「序號 X 緊鄰序號 Y」的問題**：

1. ✅ **立即修改**: `innerOrderMethod` 從 `nearest` 改成 `2opt-inner`
2. ✅ **降低群組大小**: `maxGroupSize` 從 40 降到 25-30
3. ✅ **檢查群組排序**: 使用 `2opt` 或 `sweep` 而非 `greedy`

**推薦配置**：
- **常規場景**: `2opt-inner` + `maxGroupSize: 40`
- **大訂單量**: `2opt-inner` + `maxGroupSize: 30`
- **要求最優**: `ortools` + `maxGroupSize: 25`

---

## 更新日誌

- **2025-10-27**: 首次發現 `nearest` 回字形問題，建議改用 `2opt-inner`
- **測試數據**: Group202510172101060201 驗證改善效果

