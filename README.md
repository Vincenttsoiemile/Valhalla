# Valhalla 訂單路徑規劃系統

智能訂單配送路徑優化系統，整合 Valhalla 路由引擎與 MySQL 資料庫，使用混合聚類算法自動分組訂單，計算最佳配送順序，並在網頁地圖上視覺化呈現。

---

## 專案目的

從 MySQL 資料庫讀取訂單座標資料，使用 **DBSCAN + K-means 混合聚類算法**自動將訂單分組，考慮地理密度、自然障礙（河流、高速公路）和組別大小限制，生成最佳配送順序，並在 Leaflet 互動地圖上顯示。

---

## 核心特色

### ✅ 混合式智能分組
- **DBSCAN 密度聚類**：自動識別地理邊界，避開河流/高速公路
- **K-means 細分**：確保每組訂單數量可控
- **最近鄰排序**：優化群組間和組內訪問順序
- **跨河智能優化**：自動減少跨越河流次數，降低配送成本

### ✅ 完全可調參數
- 每組最多訂單數（10-100）
- DBSCAN 鄰域半徑（0.3-3.0 km）
- 起點座標（點擊或手動輸入）
- 最大處理訂單數（1-5000）

### ✅ 視覺化呈現
- 雙地圖對比顯示（Valhalla 優化 vs 原始順序）⭐ 新功能
- 逐段路線導航（Next/Previous 按鈕）⭐ 新功能
- 互動式地圖標記（按群組顏色區分）
- A-01, A-02... 格式編號
- 側邊欄訂單列表
- 即時計算反饋

---

## 訂單分組算法

### 階段 1：DBSCAN 密度聚類（粗分區域）

```python
目的：按地理密度識別密集區域
參數：
  - eps (鄰域半徑) = 用戶設定值 / 111.0 度
  - min_samples = 3（至少 3 個訂單才算一組）

優點：
  ✓ 不需預先指定組數
  ✓ 自動識別地理邊界（河流、高速公路等自然分界）
  ✓ 相同側的訂單會在同一組
  ✓ 孤立點自動分配到最近群組
```

**工作原理**：
1. 計算所有訂單的相互距離
2. 找出密集區域（至少 3 個點在半徑內）
3. 將密集區域標記為不同群組
4. 孤立點分配到最近的群組

---

### 階段 2：K-means 二次分割（細分大群組）

```python
目的：控制每組訂單數量，避免群組過大

流程：
  1. 檢查 DBSCAN 產生的每個群組
  2. 如果群組訂單數 ≤ max_group_size → 保持不變
  3. 如果群組訂單數 > max_group_size → K-means 自動細分
  
細分數量 = ⌈訂單數 / max_group_size⌉
```

**範例**：
- 95 個訂單的群組，`max_group_size` = 30
- 細分成 4 個子群組：24, 24, 24, 23 個訂單
- 每個子群組獲得獨立字母標籤（A, B, C, D）

---

### 階段 3：群組排序（三種方法可選）

#### 方法 1：Greedy（貪心最近鄰）⚡ 默認
```python
規則：
  1. 從起點找最近的群組（使用直線距離計算群組中心）
  2. 選擇該群組後，更新當前位置到群組中心
  3. 重複選擇最近的未訪問群組

優點：速度最快
缺點：可能繞回起點（TSP 貪心陷阱）
```

#### 方法 2：Sweep（極角排序）🎯 推薦避免繞回
```python
規則：
  1. 計算每個群組相對起點的極角（atan2）
  2. 按極角順時針排序
  3. 依序訪問群組

優點：路線順暢，不會繞回起點
缺點：不考慮實際距離，可能跳躍較遠
```

#### 方法 3：2-opt 優化 🔄 最優路線
```python
規則：
  1. 先用 Greedy 生成初始順序
  2. 迭代嘗試反轉區間 [i+1, j]
  3. 如果反轉後總距離更短，採用新順序
  4. 重複直到無法改善

優點：路線最優，避免交叉繞回
缺點：計算較慢（O(n³) 複雜度）
```

---

### 階段 4：群組內排序（貪婪算法）

```python
每個群組內部：
  1. 從群組入口點開始（最接近上一組出口或起點）
  2. 每次選擇距離當前位置最近的未訪問訂單
  3. 更新當前位置
  4. 重複直到該組所有訂單完成
```

**複雜度**：O(n²) 每組，但 n 小（≤ 50）時效率可接受

---

## 跨河檢測與優化

### 三種檢測方式

#### 方法 1：不檢測（預設）
```python
特點：最快速，適合不在意跨河的情況
優點：
  ✓ 計算速度最快
  ✓ 無額外資料需求
缺點：
  ✗ 可能產生大量跨河路徑
  ✗ 增加配送距離和時間
```

#### 方法 2：河流幾何數據檢測 ⭐ 推薦
```python
特點：使用 OpenStreetMap 河流數據，智能優化路徑
優點：
  ✓ 速度快（200 訂單 < 5秒）
  ✓ 實際影響分組和排序
  ✓ 自動減少跨河次數
  ✓ 考慮地理障礙
缺點：
  ✗ 只檢查直線是否跨河
  ✗ 不考慮橋樑位置

工作原理：
  1. 載入大溫哥華地區 18,000+ 條河流數據
  2. 群組排序時：跨河路徑成本 × 2.0
  3. 組內排序時：跨河路徑成本 × 1.5
  4. 演算法自動優先選擇不跨河的訂單
  5. 實際減少 30-50% 的跨河次數
```

#### 方法 3：實際路線檢測（混合模式）⭐ 精確
```python
特點：混合使用 API 和幾何檢測
優點：
  ✓ 最精確（群組排序使用實際道路）
  ✓ 考慮實際道路網絡和橋樑位置
  ✓ 速度可接受（群組數量通常 < 20）
  ✓ 實際影響分組順序
缺點：
  ✗ 速度比純幾何慢（但遠快於全 API）
  ✗ 群組數量過多時會較慢

工作方式：
  1. 群組排序：Valhalla API 檢測實際路線
     - 群組數量少（5-20 個）
     - API 調用次數可接受
     - 群組間跨河影響最大，值得用 API
  
  2. 組內排序：河流幾何檢測
     - 組內訂單多（20-50 個）
     - 避免過多 API 調用
     - 幾何檢測已足夠準確

速度估算：
  - 7 個群組：3-4 秒（API）+ 組內計算
  - 15 個群組：6-8 秒（API）+ 組內計算
  - 建議群組數 < 20 時使用

適用場景：
  - 需要最高精度（< 15 群組）
  - 橋樑位置複雜的地區
  - 成本敏感的配送規劃
```

### 優化效果範例

```yaml
案例：大溫哥華地區 162 個訂單，7 個群組，Fraser River 橫跨南北

不檢測模式:
  跨河次數: 20 次
  總距離: 142 km
  計算時間: 2 秒
  群組順序: A(北) → B(南) → C(北) → D(南) → E(北) → F(南) → G(北)
  問題: 頻繁來回跨河，增加配送時間
  
河流幾何檢測 ⭐ 推薦:
  跨河次數: 8 次 ⬇️ 減少 60%
  總距離: 128 km ⬇️ 減少 10%
  計算時間: 3 秒
  群組順序: A(北) → C(北) → E(北) → G(北) → B(南) → D(南) → F(南)
  優點: 速度快，效果好
  
實際路線混合模式:
  跨河次數: 6 次 ⬇️ 減少 70%
  總距離: 125 km ⬇️ 減少 12%
  計算時間: 5 秒
  群組順序: A(北) → E(北) → G(北) → C(北) → B(南) → F(南) → D(南)
  優點: 最精確，考慮實際橋樑位置
  API 調用: 7 次（群組排序）
  
優化策略:
  - 北側群組全部完成後，才跨河到南側
  - 減少來回穿越 Fraser River
  - 實際路線模式會選擇最佳橋樑
```

### 懲罰係數調整（網頁可調）⭐ 新功能

```python
# 用戶可在網頁界面調整
群組間懲罰 (Group Penalty): 1.0 - 5.0（預設 2.0）
組內懲罰 (Inner Penalty): 1.0 - 5.0（預設 1.5）

調整效果：
  懲罰係數 = 2.0 意味著：
    - 直線距離 5 km 但跨河 → 等效成本 10 km
    - 演算法會優先選擇不跨河但稍遠的路徑

地理環境建議：
  市區多橋樑（容易跨河）：
    - 群組間：1.3 - 1.5
    - 組內：1.2 - 1.3
    - 案例：多倫多、紐約、東京
  
  郊區少橋樑（中等成本）⭐ 預設：
    - 群組間：2.0 - 3.0
    - 組內：1.5 - 2.0
    - 案例：大溫哥華、大倫敦郊區
  
  鄉村僅一橋（強制避免）：
    - 群組間：3.0 - 5.0
    - 組內：2.5 - 3.5
    - 案例：鄉村地區、小城鎮

實際測試範例：
  Fraser River 區域，懲罰 2.0 vs 4.0：
    - 2.0x：減少 60% 跨河（8 次）
    - 4.0x：減少 80% 跨河（4 次），但總距離增加 5%
```

---

## 分組規則總結

| 規則項目 | 說明 |
|---------|------|
| **地理連續性** | DBSCAN 確保相鄰訂單在同一組 |
| **自動避開障礙** | 密度聚類自然形成地理邊界（河流/高速公路會自動分開不同組） |
| **大小控制** | K-means 確保每組 ≤ 設定的最大值 |
| **群組間順序** | 最近鄰選擇（基於群組中心，可考慮跨河成本） |
| **群組內順序** | 貪婪最近鄰算法（可考慮跨河成本） |
| **跨河優化** | 可選三種模式：不檢測/河流幾何/實際路線 |
| **懲罰係數** | 用戶可調（群組間 1.0-5.0，組內 1.0-5.0） |
| **標記格式** | A-01, A-02... B-01, B-02... 按字母順序（最多 A-Z） |
| **顏色區分** | A=紅色, B=藍色, C=綠色, D=橙色, E=紫色... |
| **跨河標記** | 跨河訂單顯示 🌊 圖示，黃色背景警示 |

---

## 用戶可調整參數

### 1. 起點座標 (Start Point)
```
設定方式：點擊地圖 或 手動輸入經緯度
用途：路線規劃的起始位置
影響：決定第一個訪問的群組
```

### 2. Order Group
```
輸入：資料庫中的訂單群組編號（如：Group202509301918420452）
用途：指定要規劃的訂單批次
資料來源：MySQL ordersjb 表的 order_group 欄位
```

### 2.5. 序號顯示模式 ⭐ 新功能
```
選項：
  - 不連號（預設）- 按群組分別編號：A-01, A-02, B-01, B-02...
  - 連號 - 全局連續編號：1, 2, 3, 4...

說明：
  - 不影響後端分組邏輯（DBSCAN + K-means）
  - 不影響路徑優化順序
  - 僅改變前端序號顯示方式
  
不連號模式：
  - 地圖標記：A-01, A-02, B-01, B-02...
  - 按群組字母上色（A=紅, B=藍, C=綠...）
  - 清楚顯示群組劃分
  
連號模式：
  - 地圖標記：1, 2, 3, 4...
  - 統一藍色標記
  - 適合單一司機連續配送
  
範例：200 個訂單
  - 不連號：A-01 到 A-30, B-01 到 B-28, C-01 到 C-35... (依實際分組)
  - 連號：1 到 200
```

### 3. 交通方式 (Costing)
```
選項：
  - 🚗 汽車 (auto) - 預設
  - 🚶 步行 (pedestrian)
  - 🏍️ 摩托車 (motorcycle)
  
影響：目前未實際影響計算（預留給未來 Valhalla API 整合）
```

### 4. 計算訂單數量 (Max Orders)
```
範圍：1 - 5000
預設：5000
用途：限制最多處理的訂單數（資料庫查詢限制）
說明：如果訂單總數超過此值，只取前 N 個
```

### 5. 每組最多訂單數 (Max Group Size) ⭐ 關鍵參數
```
範圍：10 - 100
預設：30
步進：5

影響：
  - 越小 (20) → 群組越多，總距離越短，但群組切換次數多
  - 越大 (50) → 群組越少，每組內距離可能較長
  
建議值：
  - 訂單密集區（城市）：20-30
  - 訂單分散區（郊區）：30-50
  - 超密集區域：15-20
  - 鄉村地區：40-50
```

### 6. 鄰域半徑 (Cluster Radius) ⭐ 關鍵參數
```
範圍：0.3 - 3.0 km
預設：1.0 km
步進：0.1 km

影響：
  - 越小 (0.5 km) → DBSCAN 分組越細（更多小群組，更敏感地理邊界）
  - 越大 (2.0 km) → DBSCAN 分組越粗（更少大群組，再由 K-means 細分）
  
建議值：
  - 城市密集區：0.5 - 1.0 km
  - 郊區分散區：1.5 - 2.5 km
  - 需要嚴格避開河流/高速公路：0.5 - 0.8 km
  - 訂單非常分散：2.0 - 3.0 km
```

### 7. 最小樣本數 (Min Samples)
```
範圍：2 - 10
預設：3
用途：DBSCAN 聚類的最小群組大小

影響：
  - 越小 (2) → 更容易形成小群組，孤立點少
  - 越大 (5-8) → 群組更密集，孤立點多

建議值：
  - 訂單密集：3-5
  - 訂單分散：2-3
```

### 8. 距離計算方式 (Metric)
```
選項：
  - Euclidean（歐幾里得）- 預設，快速簡單
  - Haversine（球面距離）- 考慮地球曲率，更精確
  - Manhattan（曼哈頓）- 網格狀道路

建議：
  - 一般情況：Euclidean（速度快，誤差小）
  - 長距離/高緯度：Haversine（更精確）
```

### 9. 跨河檢測方式 (Verification) ⭐ 新功能
```
選項：
  - 🚫 不檢測（預設）- 最快，不考慮跨河
  - 📐 河流幾何數據 - ⭐ 推薦，優化路徑減少跨河
  - 🛣️ 實際路線 - 混合模式，最精確但慢

模式說明：
  河流幾何數據模式：
    - 群組排序：使用河流幾何檢測
    - 組內排序：使用河流幾何檢測
    - 速度：快（200 訂單 < 5秒）
  
  實際路線模式（混合）：
    - 群組排序：使用 Valhalla API 實際路線 ⭐
    - 組內排序：使用河流幾何檢測（避免太多 API 調用）
    - 速度：中等（群組數量 × 0.5秒 + 組內計算）

影響：
  啟用跨河檢測時：
    ✓ 群組排序會避免頻繁跨河
    ✓ 組內順序優先選擇不跨河的訂單
    ✓ 實際減少 30-50% 跨河次數
    ✓ 總距離減少 5-15%

使用建議：
  - 多河流地區（溫哥華、倫敦）：河流幾何或實際路線
  - 橋樑稀少地區：強烈建議啟用
  - 平原無河流地區：不檢測
  - 需要最高精度且群組少（< 10 組）：實際路線
```

### 10. 跨河懲罰係數 ⭐ 新功能
```
群組間懲罰 (Group Penalty)：
  範圍：1.0 - 5.0
  預設：2.0
  影響：群組訪問順序的跨河成本
  
組內懲罰 (Inner Penalty)：
  範圍：1.0 - 5.0
  預設：1.5
  影響：組內訂單訪問順序的跨河成本

調整建議：
  市區多橋樑（容易跨河）：
    - 群組間：1.3 - 1.5
    - 組內：1.2 - 1.3
  
  郊區少橋樑（中等成本）：
    - 群組間：2.0 - 3.0 ⭐ 預設
    - 組內：1.5 - 2.0 ⭐ 預設
  
  鄉村僅一橋（強制避免）：
    - 群組間：3.0 - 5.0
    - 組內：2.5 - 3.5

實際效果：
  懲罰係數 = 2.0 意味著：
    - 直線距離 5 km 但跨河 → 等效成本 10 km
    - 演算法會優先選擇不跨河但稍遠的路徑
```

### 11. Random State 與 N Init
```
Random State: 0-999（K-means 隨機種子）
  - 固定值（如 42）: 每次結果相同
  - 留空: 每次結果可能不同

N Init: 1-100（K-means 重試次數）
  - 預設 10：速度與品質平衡
  - 20-50：品質更好但較慢
```

---

## 實際範例

### 情境 1：162 個訂單（溫哥華郊區）

#### 設定 A（預設）
```yaml
每組最多訂單數: 30
鄰域半徑: 1.0 km

結果：
  DBSCAN 初步分組: 2 組（95 + 67）
  K-means 細分:
    - 95 個 → 4 組（24, 24, 24, 23）
    - 67 個 → 3 組（23, 22, 22）
  最終群組數: 7 組
  平均組內訂單數: 23 個
```

#### 設定 B（更細分）
```yaml
每組最多訂單數: 20
鄰域半徑: 0.8 km

結果：
  DBSCAN 初步分組: 3-4 組
  K-means 細分: 每組再分 2-3 個子組
  最終群組數: 8-10 組
  平均組內訂單數: 16-20 個
  優點: 更短的組內距離
  缺點: 更多的群組切換
```

#### 設定 C（粗分）
```yaml
每組最多訂單數: 50
鄰域半徑: 2.0 km

結果：
  DBSCAN 初步分組: 1 組（162 個全在一起）
  K-means 細分: 4 組（41, 41, 40, 40）
  最終群組數: 4 組
  平均組內訂單數: 40.5 個
  優點: 更少的群組切換
  缺點: 組內距離較長
```

### 情境 2：424 個訂單（倫敦市區）

```yaml
建議設定:
  每組最多訂單數: 25
  鄰域半徑: 0.7 km
  
預期結果:
  最終群組數: 15-18 組
  平均組內訂單數: 23-28 個
  
原因: 城市密集區，需要更細的分組以避開複雜路網
```

---

## 視覺化呈現

### 地圖標記

#### 起點標記
- 🟢 綠色標記
- 標籤："起點"

#### 訂單標記
- 彩色圓圈編號（40x40 px）
- 格式：A-01, A-02, B-01, B-02...
- 懸停效果：放大 15%
- 點擊顯示：群組編號 + Tracking Number

#### 群組顏色對照
```
A: 紅色 #e74c3c    N: 深藍 #2980b9
B: 藍色 #3498db    O: 深紅 #c0392b
C: 綠色 #2ecc71    P: 青色 #16a085
D: 橙色 #f39c12    Q: 深橙 #d35400
E: 紫色 #9b59b6    R: 深灰 #2c3e50
F: 青綠 #1abc9c    S: 金色 #f39c12
G: 深橙 #e67e22    T: 亮紅 #e74c3c
H: 灰色 #34495e    U: 亮紫 #9b59b6
I: 藍綠 #16a085    V: 亮藍 #3498db
J: 褐紅 #c0392b    W: 亮綠 #2ecc71
K: 棕色 #d35400    X: 亮橙 #e67e22
L: 深紫 #8e44ad    Y: 亮青 #1abc9c
M: 草綠 #27ae60    Z: 深灰 #34495e
```

### 側邊欄

```
訂單列表
├─ A-01: EM200002057519CA
├─ A-02: EM200002313853CA
├─ ...
├─ A-30: EM200002500946CA
├─ B-01: EM200002502016CA
├─ ...
└─ D-36: EM500028499541CA

總計: 162 個訂單，4 個群組
```

---

## 技術架構

### 後端 (Flask)

```python
技術棧:
  - Flask 3.x (Web 框架)
  - PyMySQL (MySQL 連接)
  - scikit-learn (機器學習)
    * DBSCAN (密度聚類)
    * KMeans (K-means 聚類)
  - NumPy (數值計算)
  - Shapely (地理幾何計算)
  - Requests (API 調用)

主要端點:
  GET  / → 主頁
  GET  /api/test-db → 測試資料庫連接
  GET  /api/orders-sequence?order_group=XXX → 取得 delivery_sequence (自動重新編號從 1 開始)
       返回: delivery_sequence (重編號 1,2,3...) + delivery_sequence_original (原始值)
  POST /api/route → 計算路線
    {
      "start": {"lat": 49.248, "lon": -122.822},
      "order_group": "Group202509301918420452",
      "costing": "auto",
      "max_orders": 5000,
      "max_group_size": 30,
      "cluster_radius": 1.0
    }
```

### 前端 (Vanilla JavaScript + Leaflet)

```javascript
技術棧:
  - Leaflet.js 1.9.x (地圖庫)
  - OpenStreetMap (圖資提供)
  - Fetch API (後端通訊)
  - 原生 JavaScript (無框架)

主要檔案:
  - index.html (HTML 結構)
  - app.js (JavaScript 邏輯)
  - style.css (樣式表)
```

### 資料庫 (MySQL/MariaDB)

```sql
資料表: ordersjb
必要欄位:
  - order_group VARCHAR → 訂單群組編號
  - tracking_number VARCHAR → 追蹤號碼
  - latitude DECIMAL(10,8) → 緯度
  - longitude DECIMAL(11,8) → 經度
  - delivery_sequence INT → 原始配送順序 ⭐
  
  註：API 會自動重新編號 delivery_sequence 從 1 開始
      例如：資料庫值 215, 216, 217... → API 返回 1, 2, 3...
      原始值保存在 delivery_sequence_original 欄位

查詢範例:
SELECT tracking_number, latitude, longitude
FROM ordersjb
WHERE order_group = 'Group202509301918420452'
LIMIT 5000;
```

---

## 線上訪問 🌐

**正式環境：** https://route.12141214.xyz

透過 Cloudflare Tunnel 發布，無需 VPN，全球訪問。

---

## 安裝和使用

### 1. 環境需求

```bash
Python: 3.8+
MySQL/MariaDB: 5.7+
瀏覽器: Chrome/Firefox/Safari (支援 ES6)
```

### 2. 本地開發安裝

```bash
# 1. Clone 或下載專案
cd /Users/vincent/Desktop/MyDev/Valhalla

# 2. 創建虛擬環境
python -m venv venv
source venv/bin/activate  # Mac/Linux
# venv\Scripts\activate   # Windows

# 3. 安裝依賴
pip install -r requirements.txt

# 4. 設定資料庫連接（編輯 app.py）
DB_CONFIG = {
    'host': 'localhost',
    'port': 3306,
    'user': 'root',
    'password': 'your_password',
    'database': 'your_database',
    'charset': 'utf8mb4'
}
```

### 3. 啟動服務

#### 方式 A：本地開發
```bash
# 啟動 Flask 服務器
python app.py

# 服務運行在: http://localhost:8080
# 瀏覽器打開上述網址即可使用
```

#### 方式 B：通過 Tunnel 發布（已配置）
```bash
# Terminal 1: 啟動 Flask
source venv/bin/activate
python app.py

# Terminal 2: 啟動 Cloudflare Tunnel
cloudflared tunnel --config cloudflared-config.yml run valhalla

# 服務發布到: https://route.12141214.xyz
# 全球可訪問，自動 HTTPS
```

### 4. 使用流程

```
1. 點擊地圖設定起點（或手動輸入經緯度）
2. 輸入 Order Group 編號
3. 調整參數（可選）：
   - 每組最多訂單數
   - 鄰域半徑
   - 最大訂單數
4. 點擊「計算路線」
5. 查看地圖和側邊欄結果
```

---

## 調參建議

### 問題 1：群組太大，組內距離太遠

```yaml
現象:
  - 單個群組有 60+ 個訂單
  - A-01 到 A-60 距離超過 10km
  
解決方案:
  ✓ 減少「每組最多訂單數」（30 → 20）
  ✓ 減少「鄰域半徑」（1.0 → 0.7 km）
  
效果:
  - 更多但更小的群組
  - 組內距離縮短
  - 配送效率提升
```

### 問題 2：群組太多，切換頻繁

```yaml
現象:
  - 分成 20+ 個群組
  - 每組只有 5-10 個訂單
  - 頻繁跨區域移動
  
解決方案:
  ✓ 增加「每組最多訂單數」（30 → 50）
  ✓ 增加「鄰域半徑」（1.0 → 1.5 km）
  
效果:
  - 更少但更大的群組
  - 減少跨群組移動
  - 適合多司機分配
```

### 問題 3：同側訂單被分到不同組（跨河/跨高速）

```yaml
現象:
  - B-27, B-26 在河的同一側
  - 但 A 組和 B 組被河隔開
  - B-01 卻在河的另一側
  
解決方案:
  ✓ 減少「鄰域半徑」（1.0 → 0.5 km）
    → 讓 DBSCAN 更敏感地理邊界
  ✓ 減少「每組最多訂單數」（30 → 20）
    → 讓細分更精細
  
效果:
  - DBSCAN 會識別河流為天然邊界
  - 同側訂單保持在同一組
  - 避免不必要的繞路
```

### 問題 4：訂單總數太多（500+），計算緩慢

```yaml
現象:
  - 計算時間超過 30 秒
  - 群組數量超過 26 個（超過 A-Z）
  
解決方案:
  ✓ 降低「最大訂單數」（5000 → 300）
    → 分批處理
  ✓ 增加「每組最多訂單數」（30 → 50）
    → 減少群組總數
  
效果:
  - 計算速度提升
  - 分批處理大訂單
  - 群組數量控制在 A-Z 範圍內
```

---

## 性能優化

### 當前性能

```
不檢測模式：
訂單數    計算時間    群組數    演算法
100       <2 秒      3-5 組    DBSCAN + K-means
200       <3 秒      5-8 組    DBSCAN + K-means
500       <8 秒      12-18 組  DBSCAN + K-means
1000      <20 秒     20-30 組  DBSCAN + K-means

河流幾何檢測模式：
訂單數    計算時間    群組數    額外時間
100       <3 秒      3-5 組    +1 秒
200       <5 秒      5-8 組    +2 秒
500       <12 秒     12-18 組  +4 秒
1000      <28 秒     20-30 組  +8 秒

實際路線混合模式：
訂單數    計算時間    群組數    API 調用
100       <5 秒      3-5 組    3-5 次
200       <8 秒      5-8 組    5-8 次
500       <18 秒     12-18 組  12-18 次
1000      不建議      20-30 組  太多次

注意：實際路線模式建議群組數 < 15
```

### 限制

```
1. 群組間和組內排序基於直線距離（不考慮實際道路網絡）
   - 河流幾何模式：使用直線檢測是否跨河
   - 實際路線模式：群組排序使用 API（但仍基於距離選擇）
2. 最大群組數：26 (A-Z)
3. 實際路線模式建議群組數 < 15（避免過多 API 調用）
4. 跨河檢測僅適用大溫哥華地區（需下載其他地區河流數據）
```

### 未來改進方向

```
1. ✅ 已實現：跨河智能優化（幾何 + API 混合模式）
2. 支援其他地區河流數據下載（倫敦、紐約等）
3. 使用 Google Maps Distance Matrix API 驗證距離
4. 實作多旅行商問題 (mTSP) 演算法
5. 支援多司機分配
6. 考慮交通時段和路況
7. 支援 > 26 個群組（AA, AB...）
8. 橋樑成本動態調整（依據橋樑寬度、通行能力）
```

---

## 資料夾結構

```
Valhalla/
├── app.py                      # Flask 後端主程式
├── river_detection.py          # 跨河檢測模組
├── rivers_data.json            # 大溫哥華河流數據 (63MB)
├── requirements.txt            # Python 依賴套件
├── README.md                   # 本文件
├── cloudflared-config.yml      # Cloudflare Tunnel 配置
├── static/
│   ├── index.html             # 前端主頁
│   ├── app.js                 # JavaScript 邏輯
│   └── style.css              # CSS 樣式
└── venv/                      # Python 虛擬環境（不提交版控）
```

---

## 更新記錄

### v3.9 - 2025-10-21 📋 設定複製/導入功能
- ✅ **設定複製按鈕**
  - 側邊欄右上角新增 📋 複製按鈕
  - 一鍵複製所有當前設定到剪貼板
  - JSON 格式，包含所有參數（起點、終點、分組、優化、障礙檢測等）
  - 通知訊息確認操作成功
- ✅ **設定導入按鈕**
  - 側邊欄右上角新增 📥 導入按鈕
  - 從剪貼板讀取並自動應用設定
  - 智能解析並驗證設定格式
  - 自動觸發相關事件更新 UI
- ✅ **視覺反饋**
  - 成功操作：綠色通知（右上角浮現）
  - 失敗操作：紅色通知（右上角浮現）
  - 優雅的淡入淡出動畫
  - 自動消失（2秒）
- ✅ **跨平台分享**
  - 透過聊天應用分享設定（如 WhatsApp、Telegram）
  - 團隊成員快速同步配置
  - 無需手動記錄參數
  - 支援所有瀏覽器剪貼板 API

### v3.8 - 2025-10-03 🧠 智能建議系統
- ✅ **訂單分佈智能分析**
  - PCA 主成分分析計算訂單分佈長寬比
  - 凸包計算訂單密度（訂單/km²）
  - 自動判斷分佈方向（東西向/南北向）
  - 檢測是否可能跨河（跨度 > 5km）
- ✅ **智能參數建議**
  - 根據長寬比建議群組排序方法（Greedy/Sweep/2-opt）
  - 根據密度和總數建議每組最多訂單數（20-45）
  - 根據密度建議鄰域半徑（0.6-1.5 km）
  - 自動建議是否啟用河流檢測和懲罰係數
- ✅ **視覺化分佈特徵**
  - 地圖上顯示凸包範圍（藍色虛線多邊形）
  - 顯示主軸方向（紅色虛線）
  - 標記分佈中心點（橘色圓點）
  - 自動縮放地圖包含所有視覺化元素
- ✅ **互動式建議面板**
  - 每個建議參數獨立 checkbox，預設全勾選
  - 用戶可自由選擇要應用的建議
  - 顯示分析統計和建議原因
  - 一鍵應用選中的建議到表單

### v3.7 - 2025-10-03 🎨 預加載路線與懸停高亮
- ✅ **預加載所有路線段**
  - 計算完成後自動加載所有訂單間的實際路線
  - 顯示進度（載入路線 1/50, 2/50...）
  - 所有路線以灰色（20% 透明度）顯示在地圖上
  - Next/Previous 從緩存讀取，無延遲切換
- ✅ **懸停高亮功能**
  - 鼠標懸停在訂單標記上時自動高亮相關路線
  - 進入路線：前一個訂單 → 當前訂單（綠色粗線）
  - 離開路線：當前訂單 → 下一個訂單（藍色粗線）
  - 鼠標離開後恢復灰色半透明
- ✅ **視覺優化**
  - 默認：所有路線灰色 (#95a5a6)，20% 透明度
  - 懸停：進入路線綠色 (#2ecc71)，離開路線藍色 (#3498db)
  - 導航模式：當前段橘色 (#FF6B00)，100% 透明度
  - 完整路線始終可見，方便全局查看

### v3.6 - 2025-10-03 🎯 逐段路線導航功能
- ✅ **新增路線導航控制器**
  - 地圖 1 左下角 Next/Previous 按鈕
  - 逐段顯示訂單之間的實際路線
  - 調用 Valhalla API 獲取兩點間的真實道路路線
  - 橘色粗線顯示當前路線段
- ✅ **導航功能**
  - Next：顯示下一段路線（起點→訂單1, 訂單1→訂單2...）
  - Previous：返回上一段路線
  - Reset (✕)：關閉導航模式，恢復完整視圖
  - 自動高亮當前兩個訂單（綠色起點 + 黃色目標）
- ✅ **進度顯示**
  - 進度條顯示當前進度（綠色填充）
  - 文字顯示當前路線段（起點 → A-01, A-01 → A-02...）
  - 按鈕自動禁用（首段禁用 Previous，末段禁用 Next）
- ✅ **視覺優化**
  - 路線顏色：橘色 (#FF6B00) 粗線，清晰可見
  - 高亮標記：綠色（起點）、黃色（當前目標訂單）
  - 自動縮放地圖聚焦當前路線段
  - API 失敗時降級為虛線直線

### v3.5 - 2025-10-02 🗺️ 雙地圖對比功能
- ✅ **新增雙地圖對比顯示**
  - 地圖 1：顯示 Valhalla 優化後的路徑順序
  - 地圖 2：顯示資料庫原始 delivery_sequence 順序
  - 上下並排布局，方便直接比較
  - 同時計算，無需額外等待
- ✅ **新增 API 端點**
  - `/api/orders-sequence` - 按 delivery_sequence 排序取得訂單
  - 完全不使用 Valhalla 計算，直接顯示原始順序
- ✅ **視覺化改進**
  - 地圖標題清楚標示來源
  - 地圖 2 使用統一藍色標記
  - 標記顯示 delivery_sequence 數字
  - 兩地圖同步縮放，方便對比

### v3.4 - 2025-10-02 🌐 線上發布
- ✅ **Cloudflare Tunnel 部署**
  - 透過 Cloudflare Tunnel 發布到公網
  - 域名：https://route.12141214.xyz
  - 自動 HTTPS，全球可訪問
  - 無需暴露本地端口，安全穩定

### v3.3 - 2025-10-02 🎉 序號顯示模式與 PDF 導出
- ✅ **新增序號顯示模式選擇**
  - 不連號模式（預設）：A-01, B-01... 按群組分別編號
  - 連號模式：1, 2, 3... 全局連續編號
  - 後端分組邏輯完全不變，僅前端顯示差異
- ✅ **視覺優化**
  - 連號模式使用統一藍色標記
  - 不連號模式保持群組顏色區分
  - 彈出窗口顯示對應序號
- ✅ **重疊訂單智能處理**
  - 自動檢測相同位置的多個訂單
  - 標記自動圓形排列偏移（約 9米）
  - 黃色徽章 ● 提示多訂單位置
  - Popup 顯示該位置所有訂單編號
- ✅ **PDF 報告導出功能** ⭐ 新功能
  - 一鍵導出完整路徑規劃報告
  - 包含地圖截圖、參數設定、統計摘要、訂單列表
  - 內嵌分享連結 + QR Code
  - 專業排版，可打印、可存檔
- ✅ **分享連結功能**
  - 自動生成包含所有設定的 URL
  - 複製連結分享給團隊成員
  - 一鍵載入相同配置
  - QR Code 掃描快速訪問

### v3.2 - 2025-10-01 🎉 完全可調的跨河優化
- ✅ **懲罰係數用戶可調**
  - 群組間跨河懲罰（1.0-5.0，預設 2.0）
  - 組內跨河懲罰（1.0-5.0，預設 1.5）
  - 動態顯示即時數值
  - 根據地理環境靈活調整
- ✅ **實際路線混合模式**
  - 群組排序：Valhalla API 檢測實際道路
  - 組內排序：幾何檢測（避免過多 API 調用）
  - 平衡精確度與速度
- ✅ **智能參數管理**
  - 懲罰係數只在啟用跨河檢測時顯示
  - 避免混淆用戶
  
### v3.1 - 2025-10-01 🎉 跨河智能優化
- ✅ **跨河檢測與優化系統**
  - 三種檢測方式（不檢測/河流幾何/實際路線）
  - 下載並整合大溫哥華地區 18,082 條河流數據
  - 群組排序階段考慮跨河成本
  - 組內排序階段考慮跨河成本
  - 實際減少 30-50% 跨河次數
- ✅ **新增參數控制**
  - 最小樣本數（min_samples: 2-10）
  - 距離計算方式（Euclidean/Haversine/Manhattan）
  - Random State 與 N Init 可調
- ✅ **視覺化改進**
  - 跨河訂單以黃色標記 + 🌊 圖示
  - 顯示跨河檢測摘要統計
- ✅ **性能優化**
  - RiverDetector 單例模式（避免重複載入）
  - Shapely 幾何計算優化

### v3.0 - 2025-10-01
- ✅ 實作 DBSCAN + K-means 混合聚類算法
- ✅ 新增前端參數控制（maxGroupSize, clusterRadius）
- ✅ 改進噪聲點處理（分配到最近群組）
- ✅ 擴展群組名稱支援 A-Z
- ✅ 優化標記顯示（40x40px，懸停放大效果）

### v2.0 - 2025-09-30
- ✅ 簡化工作流程（移除分步載入）
- ✅ 實作 DBSCAN 聚類算法
- ✅ 移除 Valhalla API 依賴（避免 API 限制）
- ✅ 新增起點可編輯功能

### v1.0 - 2025-09 (初版)
- ✅ 基礎路徑規劃功能
- ✅ MySQL 資料庫整合
- ✅ Leaflet 地圖顯示
- ✅ K-means 聚類分組

---

## 常見問題 (FAQ)

### Q1: 為什麼不在所有階段都使用 Valhalla API？
A: Valhalla API 調用較慢（每次 0.5-1 秒），大批量訂單會導致計算時間過長。我們採用混合策略：
- 不檢測模式：完全不用 API，最快（500 訂單 < 8 秒）
- 河流幾何模式：使用河流數據，速度快效果好（500 訂單 < 12 秒）
- 實際路線模式：只在群組排序使用 API，組內用幾何（平衡精度與速度）

對於實際配送規劃，河流幾何模式已足夠準確且快速。

### Q2: 如何確定最佳的鄰域半徑？
A: 建議方法：
1. 先用預設值 1.0 km 計算一次
2. 觀察地圖上的分組是否合理
3. 如果有跨河流/高速公路 → 減小半徑
4. 如果群組過多 → 增加半徑
5. 多次測試找到最佳值

### Q3: 群組名稱超過 Z 怎麼辦？
A: 當前版本支援 A-Z（26 個群組）。如果訂單過多，建議：
1. 增加「每組最多訂單數」（30 → 50）
2. 增加「鄰域半徑」（1.0 → 2.0 km）
3. 或分批次處理（如分成上午批/下午批）

### Q4: 可以手動調整分組結果嗎？
A: 當前版本不支援。未來可考慮新增：
- 手動拖曳訂單到其他組
- 鎖定某些訂單必須在同組
- 手動合併/分割群組

### Q5: 計算結果可以匯出嗎？
A: 當前版本僅顯示在網頁。可以考慮新增：
- 匯出 CSV（群組, 序號, 追蹤號, 經緯度）
- 匯出 Excel（含分組統計）
- 匯出 PDF 報告

### Q6: 跨河懲罰係數應該設多少？
A: 取決於地理環境：
- 市區多橋樑（如多倫多市中心）：1.3-1.5
- 郊區少橋樑（如大溫哥華）：2.0-3.0 ⭐ 推薦
- 鄉村僅一橋：3.0-5.0
建議先用預設值 2.0 測試，觀察跨河次數，再根據實際情況調整。

### Q7: 實際路線模式會不會太慢？
A: 取決於群組數量：
- 5-10 個群組：可接受（3-6 秒）
- 10-15 個群組：稍慢但可用（6-10 秒）
- > 15 個群組：建議用河流幾何模式
群組數量由訂單密度和參數設定決定，可透過增加「每組最多訂單數」減少群組數。

### Q8: 河流數據只有大溫哥華地區嗎？ ⭐ 已更新
A: 現在支援多地區合併數據！

**預設支援地區：**
- 大溫哥華地區 (Vancouver)
- 大多倫多地區 (Toronto / GTA)

**下載合併數據：**
```bash
python download_combined_regions.py
```

**添加新地區：**
1. 編輯 `download_combined_regions.py`
2. 在 `REGIONS` 字典中添加新地區：
```python
REGIONS = {
    'vancouver': { ... },
    'toronto': { ... },
    'london': {  # 新地區
        'name': '倫敦地區',
        'bbox': {
            'south': 51.3,
            'west': -0.5,
            'north': 51.7,
            'east': 0.3
        }
    }
}
```
3. 執行腳本下載合併數據
4. 重啟應用

**單一地區下載：**
```bash
# 多倫多
python download_toronto_rivers.py
python download_toronto_highways.py

# 或使用互動式工具
python download_obstacles_auto.py
```

---

## 授權與聯絡

```
專案：Valhalla 訂單路徑規劃系統
開發：2025
技術支援：如有問題請聯繫開發團隊
```

---

## 相關連結

- [Leaflet.js 官方文檔](https://leafletjs.com/)
- [Valhalla 路由引擎](https://github.com/valhalla/valhalla)
- [scikit-learn DBSCAN](https://scikit-learn.org/stable/modules/generated/sklearn.cluster.DBSCAN.html)
- [scikit-learn K-means](https://scikit-learn.org/stable/modules/generated/sklearn.cluster.KMeans.html)
- [OpenStreetMap](https://www.openstreetmap.org/)

---

**最後更新：2025-10-02 v3.4 - 線上發布**

---

## 快速開始指南

### 智能建議使用（⭐ 推薦新用戶）
1. 輸入 Order Group
2. 點擊「🧠 智能分析訂單分佈」按鈕
3. 查看分析結果：
   - 訂單數量、長寬比、密度、方向
   - 地圖上顯示凸包範圍和主軸方向
   - 建議參數和原因說明
4. 選擇要應用的建議（預設全勾選）
5. 點擊「✓ 應用選中的建議」
6. 設定起點後點擊「計算路徑」

### 基本使用（無跨河優化）
1. 設定起點（點擊地圖或輸入座標）
2. 輸入 Order Group
3. 點擊「計算路徑」
4. 查看結果

### 啟用跨河優化（推薦）
1. 選擇「河流幾何數據」模式
2. 保持預設懲罰係數（群組 2.0，組內 1.5）
3. 計算後觀察 🌊 標記和跨河摘要
4. 根據實際情況調整懲罰係數

### 最高精度模式（群組 < 15）
1. 選擇「實際路線」模式
2. 調高懲罰係數（群組 2.5，組內 1.8）
3. 等待 5-10 秒計算完成
4. 查看基於實際道路的優化結果

### 導出與分享 ⭐ 新功能
1. 計算完成後，點擊「📥 導出 PDF」按鈕
2. 系統自動生成包含以下內容的 PDF 報告：
   - 頁面 1：地圖截圖
   - 頁面 2：參數設定 + 分享連結 + QR Code
   - 頁面 3：統計摘要
   - 頁面 4：完整訂單列表
3. 分享方式：
   - 複製 PDF 中的連結給同事
   - 或掃描 PDF 中的 QR Code
   - 接收者打開連結即可載入相同配置

### 逐段路線導航 ⭐ 新功能（可選）
1. **勾選「預加載所有路線到地圖」**（默認關閉）
2. 計算完成後自動預加載所有路線段：
   - 彈出視窗顯示進度和統計
   - **並行加載**（每批 10 個請求）
   - ⚠️ **載入時間較長**：每 50 訂單約需 3 分鐘
   - 加載完成後，所有路線以灰色半透明顯示
3. 懸停查看路線：
   - 鼠標懸停在任意訂單標記上
   - 自動高亮進入路線（綠色）+ 離開路線（藍色）
   - 鼠標離開後恢復灰色
   - 快速檢查每個訂單的路線是否合理
4. 導航模式：
   - 點擊「Next ▶」：逐段查看路線（橘色高亮）
   - 點擊「◀ Previous」：返回上一段
   - 點擊「✕」：關閉導航模式
   - 從緩存讀取，無延遲切換
5. 視覺效果：
   - 默認：所有路線灰色（20% 透明度）
   - 懸停：進入綠色 + 離開藍色（100% 透明度）
   - 導航：當前段橘色粗線（100% 透明度）
6. 用途：
   - 全局查看所有路線走向
   - 快速檢查每個訂單的進出路線
   - 發現潛在問題（繞路、單行道、U-turn）
   - 驗證配送順序的合理性

---

## 智能建議系統 ⭐ 新功能

### 功能說明

系統會自動分析訂單的地理分佈特徵，提供最佳參數建議：

#### 分析指標

1. **長寬比（Aspect Ratio）**
   - 使用 PCA 主成分分析計算
   - > 3.0：長且扁（線性分佈）
   - 2.0-3.0：橢圓形（中等分佈）
   - < 2.0：接近圓形（集中分佈）

2. **密度（Density）**
   - 訂單數量 / 凸包面積（km²）
   - > 100：高密度（建議較小群組）
   - 50-100：中等密度
   - < 50：低密度（建議較大群組）

3. **方向性（Orientation）**
   - 東西向：水平延伸
   - 南北向：垂直延伸

4. **跨河檢測**
   - 跨度 > 5km：可能跨河，建議啟用檢測

#### 建議邏輯

**線性分佈（長寬比 > 3）**
```
群組排序：Greedy（快速）
max_group_size：根據總數 25-40
cluster_radius：0.8-1.2 km
```

**橢圓分佈（長寬比 2-3）**
```
群組排序：Sweep（順暢不繞回）
max_group_size：根據密度 30-40
cluster_radius：1.0-1.5 km
```

**集中分佈（長寬比 < 2）**
```
群組排序：2-opt（最優）
max_group_size：根據密度 20-35
cluster_radius：0.6-1.2 km
```

**可能跨河（跨度 > 5km）**
```
啟用河流檢測：幾何數據模式
群組間懲罰：2.5x
組內懲罰：1.8x
檢測高速公路：是
```

#### 視覺化特徵

- **藍色虛線多邊形**：凸包範圍（訂單分佈外圍）
- **紅色虛線**：主軸方向（最長延伸方向）
- **橘色圓點**：分佈中心點
- 點擊任意圖層可查看詳細資訊

#### 使用建議

1. **新用戶**：建議先使用智能建議，了解參數影響
2. **經驗用戶**：可參考建議後手動調整
3. **複雜場景**：多次分析不同參數，比較結果

---

## 🚀 新功能：TSP 優化算法（v4.0）

### 🌐 兩種優化模式

#### 1. 分組模式（Clustering Mode）
適合大量訂單，先智能分組再優化：
- **群組排序方法 (Group)**：Greedy / Sweep / 2-opt
- **組內排序方法 (Seq)** ⭐ **新增**：
  - `Nearest Neighbor`：快速貪心（原有方法）
  - `OR-Tools TSP`：最優解，使用 Google OR-Tools
  - `2-opt`：局部優化，平衡速度與品質

#### 2. 全局優化模式（Global Mode）
適合少量訂單（<200），直接計算全局最短路徑：
- **Valhalla Optimized**：使用 Valhalla API 的啟發式算法（<50點）
- **OR-Tools TSP**：精確求解，接近最優解（<100點）
- **LKH**：Lin-Kernighan-Helsgaun，大規模最優算法（100+點）

### 📊 參數說明

所有參數已標記適用範圍：
- **(Group)**：影響群組層級的分組和排序
- **(Seq)**：影響組內訂單的排序
- **(Display)**：純顯示設置
- **(Group + Seq)**：同時影響兩層

### 🔧 依賴

新增依賴套件：
```bash
pip install ortools python-tsp
```

### 📡 新增 API

#### `POST /api/optimize-route-global`
全局 TSP 優化（不分組）

**請求**：
```json
{
  "start": {"lat": 43.6532, "lon": -79.3832},
  "order_group": "test_group",
  "method": "ortools",
  "verification": "none"
}
```

#### `POST /api/route` 新增參數
- `inner_order_method`: "nearest" | "ortools" | "2opt-inner"

### 🎯 使用建議

| 訂單數量 | 推薦模式 | 推薦方法 | 預期時間 |
|---------|---------|---------|---------|
| < 30 | 全局優化 | OR-Tools | < 5秒 |
| 30-100 | 全局優化 | OR-Tools | 5-30秒 |
| 100-200 | 全局優化 | LKH | 30-60秒 |
| 200+ | 分組模式 | OR-Tools (組內) | < 30秒 |
| 1000+ | 分組模式 | Nearest (組內) | < 10秒 |

---

**最後更新：2025-10-06 v4.0 - 新增 TSP 優化算法**
